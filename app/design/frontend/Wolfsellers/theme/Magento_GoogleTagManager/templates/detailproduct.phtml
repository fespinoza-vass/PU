<?php
/**
 * Copyright Â© Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */
use Magento\GoogleTagManager\Block\Ga;
?>
<?php
/** @var \WolfSellers\GoogleTagManager\Block\ListJson $block */
$product = $block->getCurrentProduct();

$gender = '';
$size = '';
$category = null;
$subcategory = null;
$family = null;

$attr = $product->getResource()->getAttribute('tamano');
if ($attr->usesSource()) {
    $size = $attr->getSource()->getOptionText($product->getTamano());
}

$attr = $product->getResource()->getAttribute('genero');
if ($attr->usesSource()) {
    $gender = $attr->getSource()->getOptionText($product->getGenero());
}

$category = !empty( $product->getCategoria()) ?  $product->getCategoria() : null;
$subcategory = !empty( $product->getSubCategoria()) ?  $product->getSubCategoria() : null;
$family = !empty( $product->getCategoria()) ?  $product->getFamilia() : null;


$attributes = $product->getAttributes();
$brand = '';

foreach($attributes as $attribute){
    if($attribute->getName() === 'manufacturer') {
        $brand = $attribute->getFrontend()->getValue($product);
    }
}
$imageUrl = $this->helper('Magento\Catalog\Helper\Image')
    ->init($product, 'product_base_image')->getUrl();

$rules = $block->getRules($product->getId());

$data = [];
if($rules){
    foreach ($rules as $rule){
        $data[] = $rule;
    }
}
$data = implode( ', ', $data);
?>

<script type="text/x-magento-init">
    {
        "*": {
            "Magento_GoogleTagManager/js/actions/product-detail": {
                "product":{
                    "id": "<?=$block->escapeJs($product->getId());?>",
                    "totalValue": "<?=$block->escapeJs($product->getFinalPrice());?>",
                    "name": "<?=$block->escapeJs($product->getName());?>",
                    "sku": "<?=$block->escapeJs($product->getSku());?>",
                    "category": "<?=$block->escapeJs($category);?>",
                    "sub_categoria": "<?=$block->escapeJs($subcategory);?>",
                    "familia": "<?=$block->escapeJs($family);?>",
                    "brand": "<?=$block->escapeJs($brand);?>",
                    "productURL": "<?=$block->escapeJs($product->getProductUrl());?>",
                    "imageURL": "<?=$block->escapeJs($imageUrl);?>",
                    "genero": "<?=$block->escapeJs($gender);?>",
                    "tamano": "<?=$block->escapeJs($size);?>",
                    "promotion": "<?=$block->escapeJs($data);?>"
                },
                "currencyCode": "<?=$block->getCurrencyCode();?>"
            }
        }
    }
</script>
